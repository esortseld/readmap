<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>作品カード – すやネコ文庫</title>
<style>
:root{--bg:#faf8f6;--card:#fff;--ink:#222;--sub:#555;--line:#eee}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;color:var(--ink);background:var(--bg)}
header{padding:36px 16px;background:linear-gradient(180deg,#f8efe8,transparent)}
.wrap{max-width:960px;margin:0 auto;padding:0 16px}
a.link{color:#345;text-decoration:none;border-bottom:1px solid #ccd}
h1{margin:6px 0 4px;font-size:clamp(1.4rem,3.2vw,2.1rem)}
.meta{color:#666;margin:0 0 12px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0}
.badges{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 2px}
.badge{font-size:.75rem;padding:4px 8px;border-radius:999px;border:1px solid #e3e0dd;background:#faf9f8;color:#444}
.grid{display:grid;grid-template-columns:12em 1fr;gap:8px 12px}
dt{color:#444}
dd{margin:0}
.muted{color:#777;font-size:.9rem;margin-top:8px}
@media (prefers-color-scheme:dark){
  :root{--bg:#0f0e0e;--card:#151515;--ink:#eee;--sub:#aaa;--line:#2a2a2a}
  a.link{color:#cfe2ff;border-bottom-color:#2a3f66}
  .badge{border-color:#333;background:#1a1a1a;color:#ccc}
}
</style>
</head>
<body>
<header class="wrap">
  <a class="link" href="../index.html">← 読書地図にもどる</a>
  <h1 id="title">（作品名）</h1>
  <p class="meta" id="author">（著者）</p>
</header>

<main class="wrap">
  <section class="card">
    <div class="badges" id="badges"></div>
    <dl class="grid" id="facts"></dl>
    <p class="muted">※この枠は事実ベースの情報です（CSVの列を自動反映）。</p>
  </section>

  <section class="card" id="subjective" style="display:none">
    <h2 style="margin:0 0 10px;font-size:1.05rem">主観メモ</h2>
    <dl class="grid" id="ratings"></dl>
  </section>
</main>

<footer><div class="wrap"><small>© すやネコ文庫</small></div></footer>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL = '../data/works.csv?v=' + Date.now(); // キャッシュ回避

// 現在ページの slug（ファイル名）を取得
const slug = location.pathname.split('/').pop().replace(/\.html$/,'');

// ユーティリティ
const clean = s => String(s ?? '').trim();
const pick = (row, keys) => {
  for (const k of keys) { const v = row[k]; if (v !== undefined && clean(v) !== '') return clean(v); }
  return '';
};
const splitList = (t) => !t ? [] : clean(t).split(/[、,，／\/\|]\s*|\s{2,}/).map(s=>s.trim()).filter(Boolean);

// 主要カラムの別名吸収（最低限：slug/作品名/作者）
const ALIAS = {
  slug:   ['slug','Slug','SLUG','id','ID'],
  title:  ['作品名','title','書名'],
  author: ['作者','著者','author']
};

// 自動判定のためのルール（ヘッダテキストで振り分け）
const isBadgeHeader = (h) => /(受賞|受賞歴|ジャンル|作品ジャンル|テーマ|時代|キーワード|タグ)/i.test(h);
const isSubjectiveHeader = (h) => /(度$|満足度|スコア|評価|主観)/.test(h);

// ラベル整形（不要な記号や英名を除去）
const prettyLabel = (h) => clean(h).replace(/\s*\(.*?\)\s*$/,'').replace(/^主観[:：]\s*/,'').replace(/^badge[:：]\s*/i,'');

// 表示順のヒント（あれば優先、それ以外はCSVの順）
const PREFERRED_ORDER = ['出版社','刊行','ページ数','初出','作品タイプ','地理的舞台','登場人物','あらすじ','キャプション','リール'];

// CSV読み込み
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  encoding: 'utf-8',
  complete: ({ data, meta }) => {
    // ヘッダ順（未知列の並びに使用）
    const headers = meta.fields || Object.keys(data[0] || {});

    // 対象行を slug で特定（英数のみ比較）
    const onlyAZ09 = s => clean(s).replace(/[^A-Za-z0-9]/g,'');
    const row = data.find(r => onlyAZ09(pick(r, ALIAS.slug)) === onlyAZ09(slug));

    if (!row) {
      document.querySelector('main').innerHTML =
        `<section class="card">データが見つかりません（slug: ${slug}）。</section>`;
      return;
    }

    // タイトル・著者
    const title  = pick(row, ALIAS.title)  || '(無題)';
    const author = pick(row, ALIAS.author) || '';
    document.getElementById('title').textContent  = title;
    document.getElementById('author').textContent = author;
    document.title = `${title} – 作品カード | すやネコ文庫`;

    // 列を走査 → バッジ / 主観 / 事実 に自動分類
    const EXCLUDE = new Set([...ALIAS.slug, ...ALIAS.title, ...ALIAS.author]);

    const badges = [];
    const subjective = []; // [label, value]
    const facts = [];      // [label, value]

    headers.forEach(h => {
      if (!h || EXCLUDE.has(h)) return;
      const raw = row[h];
      if (raw === undefined || clean(raw) === '') return;

      const label = prettyLabel(h);
      const value = clean(raw);

      if (isBadgeHeader(h)) {
        badges.push(...splitList(value));
      } else if (isSubjectiveHeader(h)) {
        subjective.push([label, value]);
      } else {
        facts.push([label, value]);
      }
    });

    // 事実の並び：PREFERRED_ORDERを上に、その後はCSVの順
    const orderIndex = (label) => {
      const i = PREFERRED_ORDER.indexOf(label);
      return i === -1 ? 999 : i;
    };
    facts.sort((a,b) => orderIndex(a[0]) - orderIndex(b[0]));

    // 描画
    document.getElementById('badges').innerHTML =
      badges.map(v => `<span class="badge">${v}</span>`).join('');

    // 複数値は箇条書きに
    const renderValue = (v) => {
      const list = splitList(v);
      if (list.length >= 2) {
        return `<ul style="padding-left:1.1em;margin:.2em 0">${list.map(x=>`<li>${x}</li>`).join('')}</ul>`;
      }
      return v;
    };

    document.getElementById('facts').innerHTML =
      facts.map(([k,v]) => `<dt>${k}</dt><dd>${renderValue(v)}</dd>`).join('');

    if (subjective.length) {
      document.getElementById('subjective').style.display = '';
      document.getElementById('ratings').innerHTML =
        subjective.map(([k,v]) => `<dt>${k}</dt><dd>${v}</dd>`).join('');
    }
  },
  error: (err) => {
    console.error(err);
    document.querySelector('main').innerHTML =
      '<section class="card">CSVの読み込みに失敗しました。</section>';
  }
});
</script>
</body>
</html>
